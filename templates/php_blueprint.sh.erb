#!/bin/bash
#
##################################################################
#
# Script to build PHPs for use with CloudFoundry
#
#   Author:  Daniel Mikusa
#     Date:  08-28-2014
#
##################################################################
#  Configuration
#

<%= File.read(File.expand_path('../helpers/php/install-deps.sh', __FILE__)) %>
<%= File.read(File.expand_path('../helpers/php/php-common.sh', __FILE__)) %>

INSTALLATION_DIR=$1

APP_DIR=/app
mkdir $INSTALLATION_DIR/php
ln -s $INSTALLATION_DIR/php $APP_DIR/php

PHP_VERSION=<%= binary_version %>
ZTS_VERSION=<%= external_libraries[:ZTS_VERSION] %>

# Third Party Module Versions
RABBITMQ_C_VERSION=<%= external_libraries[:RABBITMQ_C_VERSION] %>
LIBMEMCACHED_VERSION=<%= external_libraries[:LIBMEMCACHED_VERSION] %>
HIREDIS_VERSION=<%= external_libraries[:HIREDIS_VERSION] %>
LUA_VERSION=<%= external_libraries[:LUA_VERSION] %>

declare -A MODULES
<% external_extensions.each do |extension| %>
MODULES[<%= extension.name %>]="<%= extension.version %>"
<% end %>
# location where files are built
BUILD_DIR=`pwd`/build

##################################################################
set -e

function build_php() {
  cd "$BUILD_DIR"
  if [ ! -d "php-$PHP_VERSION" ]; then
    curl -L -o "php-$PHP_VERSION.tar.bz2" "http://us1.php.net/get/php-$PHP_VERSION.tar.bz2/from/us2.php.net/mirror"
    tar jxf "php-$PHP_VERSION.tar.bz2"
    rm "php-$PHP_VERSION.tar.bz2"
    cd "php-$PHP_VERSION"
    LIBS=-lz ./configure \
      --prefix="$APP_DIR/php" \
      --disable-static \
      --enable-shared \
      --enable-ftp=shared \
      --enable-sockets=shared \
      --enable-soap=shared \
      --enable-fileinfo=shared \
      --enable-bcmath \
      --enable-calendar \
      --with-kerberos \
      --enable-zip=shared \
      --with-bz2=shared \
      --with-curl=shared \
      --enable-dba=shared \
      --with-cdb \
      --with-gdbm \
      --with-mcrypt=shared \
      --with-mhash=shared \
      --with-mysql=shared \
      --with-mysqli=shared \
      --enable-pdo=shared \
      --with-pdo-sqlite=shared,/usr \
      --with-pdo-mysql=shared,mysqlnd \
      --with-gd=shared \
      --with-jpeg-dir=/usr \
      --with-freetype-dir=/usr \
      --enable-gd-native-ttf \
      --with-pdo-pgsql=shared \
      --with-pgsql=shared \
      --with-pspell=shared \
      --with-gettext=shared \
      --with-gmp=shared \
      --with-imap=shared \
      --with-imap-ssl=shared \
      --with-ldap=shared \
      --with-ldap-sasl \
      --with-zlib=shared \
      --with-xsl=shared \
      --with-snmp=shared \
      --enable-mbstring=shared \
      --enable-mbregex \
      --enable-exif=shared \
      --with-openssl=shared \
      --enable-fpm \
      --enable-pcntl=shared \
      --with-readline=shared
  else
    cd "php-$PHP_VERSION"
  fi
  # Build
  make -j 8
  make install
  cd "$BUILD_DIR"
}

package_php_extensions() {
  cd "$APP_DIR"

  package_php_extension "libc-client.so.2007e"
  package_php_extension "libmcrypt.so.4"
  package_php_extension "libaspell.so.15" "libpspell.so.15"

  package_php_extension_snmp

  package_php_extension "$APP_DIR/librmq-$RABBITMQ_C_VERSION/lib/librabbitmq.so.1"
  package_php_extension "libicui18n.so.52" "libicuuc.so.52" "libicudata.so.52" "libicuio.so.52"
  package_php_extension "$APP_DIR/libmemcached-$LIBMEMCACHED_VERSION/lib/libmemcached.so.11"
  package_php_extension "$APP_DIR/hiredis-$HIREDIS_VERSION/lib/libhiredis.so.0.10"

  cd "$APP_DIR"
}

# setup build directory
if [ ! -d "$BUILD_DIR" ]; then
  mkdir "$BUILD_DIR"
fi

# build and install php
build_php
build_external_extensions

# Remove unused files
rm "$APP_DIR/php/etc/php-fpm.conf.default"
rm -rf "$APP_DIR/php/include"
rm -rf "$APP_DIR/php/php"
rm -rf "$APP_DIR/php/lib/php/build"
rm "$APP_DIR/php/bin/php-cgi"
find "$APP_DIR/php/lib/php/extensions" -name "*.a" -type f -delete

# Build binaries - one for PHP, one for FPM and one for each module
package_php_extensions

echo "Done!"
